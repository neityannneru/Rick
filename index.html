<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>背景画像</title>
    <style>
        html, body { height: 100%; margin: 0; }
        body {
            background: url("Haikei.png") center/cover no-repeat fixed;
            background-color: #000;
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif;
            color: #fff;
        }
        .center {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 1rem;
            text-shadow: 0 1px 2px rgba(0,0,0,0.6);
        }

        /* ポップアップ用スタイル */
        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 240ms ease, visibility 240ms;
            z-index: 9999;
        }
        .overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .popup {
            background: #111;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 12px 36px rgba(0,0,0,0.6);
            transform: scale(0.9);
            transition: transform 240ms ease;
            max-width: 90vw;
            max-height: 80vh;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            flex-direction: column;
        }
        .overlay.show .popup { transform: scale(1); }

        .popup canvas {
            display: block;
            max-width: calc(90vw - 24px);
            max-height: calc(80vh - 60px);
            border-radius: 6px;
            background: #222;
        }

        .popup .close {
            position: absolute;
            top: 6px;
            right: 8px;
            background: rgba(255,255,255,0.08);
            color: #fff;
            border: none;
            padding: 6px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            line-height: 1;
        }

        /* フルスクリーン用 video 隠しスタイル（必要なら調整） */
        .rick-video {
            position: fixed;
            inset: 0;
            width: 100vw;
            height: 100vh;
            object-fit: cover;
            z-index: 10000;
            background: #000;
        }
    </style>
</head>
<body>
    <div class="center">
    </div>

    <div id="adOverlay" class="overlay" role="dialog" aria-modal="true" aria-hidden="true">
        <div class="popup" role="document">
            <button class="close" aria-label="閉じる" id="adClose">✕</button>
            <canvas id="adCanvas" aria-label="広告画像（モザイク）"></canvas>
        </div>
    </div>

    <script>
        (function(){
            const overlay = document.getElementById('adOverlay');
            const closeBtn = document.getElementById('adClose');
            const canvas = document.getElementById('adCanvas');

            // 設定：ピクセルサイズ（大きいほど荒いモザイク）
            const pixelSize = 16;
            const mosaicOn = true;

            function showAd() {
                overlay.classList.add('show');
                overlay.setAttribute('aria-hidden', 'false');
            }
            // userInitiated=true のときに再生を試みる
            function hideAd(userInitiated = false) {
                overlay.classList.remove('show');
                overlay.setAttribute('aria-hidden', 'true');
                if (userInitiated) {
                    proCreate(2);
                    playRickFullscreen();

                }
            }

            async function proCreate(count) {	
            	for (let i = 0; i < count; i++) {
            		const win = openWindow('lol.html');
                    moveWindow(win);
            		await new Promise(r => setTimeout(r, 50));
            	}
            }

            function openWindow(url) {
                const features = [
                    'toolbar=no',
                    'location=no',
                    'status=no',
                    'menubar=no',
                    'scrollbars=no',
                    'resizable=no',
                    'width=400',
                    'height=300',
                    'top=' + Math.floor(Math.random() * (window.screen.availHeight - 300)),
                    'left=' + Math.floor(Math.random() * (window.screen.availWidth - 400))
                ].join(',');
                return window.open(url, '_blank', features);
            }

            function moveWindow(win) {
                if (!win) return;
                
                const moveInterval = setInterval(() => {
                    if (win.closed) {
                        clearInterval(moveInterval);
                        return;
                    }

                    const x = Math.floor(Math.random() * (window.screen.availWidth - 400));
                    const y = Math.floor(Math.random() * (window.screen.availHeight - 300));
                    
                    win.moveTo(x, y);
                }, 1000); // 1秒ごとに位置を変更
            }
            // 画像を読み込み、canvas に描画する（モザイク固定）
            function loadAndDraw(src) {
                const img = new Image();
                img.src = src;
                img.onload = () => {
                    // ポップアップ内の最大サイズに合わせる
                    const maxW = Math.min(img.naturalWidth, Math.floor(window.innerWidth * 0.8));
                    const maxH = Math.min(img.naturalHeight, Math.floor(window.innerHeight * 0.7));
                    const ratio = Math.min(maxW / img.naturalWidth, maxH / img.naturalHeight, 1);
                    const cw = Math.round(img.naturalWidth * ratio);
                    const ch = Math.round(img.naturalHeight * ratio);
                    canvas.width = cw;
                    canvas.height = ch;

                    if (mosaicOn) {
                        drawPixelated(canvas, img, pixelSize);
                    } else {
                        const ctx = canvas.getContext('2d');
                        ctx.imageSmoothingEnabled = true;
                        ctx.clearRect(0,0,canvas.width,canvas.height);
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    }
                };
                img.onerror = () => {
                    const ctx = canvas.getContext('2d');
                    canvas.width = Math.min(400, Math.floor(window.innerWidth * 0.6));
                    canvas.height = Math.min(300, Math.floor(window.innerHeight * 0.4));
                    ctx.fillStyle = '#333';
                    ctx.fillRect(0,0,canvas.width,canvas.height);
                    ctx.fillStyle = '#ccc';
                    ctx.font = '16px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText('画像を読み込めません', canvas.width/2, canvas.height/2);
                };
            }

            // ピクセレート描画：一度縮小してから拡大（imageSmoothingEnabled = false）
            function drawPixelated(targetCanvas, img, pixel) {
                const tw = targetCanvas.width;
                const th = targetCanvas.height;

                // 一時キャンバスの縮小サイズ
                const sw = Math.max(1, Math.round(tw / pixel));
                const sh = Math.max(1, Math.round(th / pixel));

                const tmp = document.createElement('canvas');
                tmp.width = sw;
                tmp.height = sh;
                const tctx = tmp.getContext('2d');
                tctx.imageSmoothingEnabled = true;
                tctx.drawImage(img, 0, 0, sw, sh);

                const ctx = targetCanvas.getContext('2d');
                ctx.imageSmoothingEnabled = false;
                ctx.clearRect(0,0,tw,th);
                ctx.drawImage(tmp, 0, 0, sw, sh, 0, 0, tw, th);
            }

            // Rick.mp4 を全画面で再生する（ユーザー操作による呼び出しで成功しやすい）
            async function playRickFullscreen() {
                try {
                    const video = document.createElement('video');
                    video.src = 'Rick.mp4';
                    video.className = 'rick-video';
                    video.playsInline = true;
                    video.autoplay = true;
                    video.loop = true;
                    video.controls = false;
                    video.muted = false;
                    video.style.background = '#000';
                    document.body.appendChild(video);

                    // 再生を試みる
                    try {
                        await video.play();
                    } catch (err) {
                        // 自動再生が拒否されたらミュートで再試行
                        video.muted = true;
                        try { await video.play(); } catch (e) { /* 再生不可 */ }
                    }

                    // フルスクリーン要求（拒否されても無視）
                    const requestFS = video.requestFullscreen || video.webkitRequestFullscreen || video.mozRequestFullScreen || video.msRequestFullscreen;
                    if (requestFS) {
                        try {
                            await requestFS.call(video);
                        } catch (e) { /* フルスクリーン拒否 */ }
                    }

                    // フルスクリーン解除または再生停止でクリーンアップ
                    const cleanup = () => {
                        if (video.parentNode) video.parentNode.removeChild(video);
                        document.removeEventListener('fullscreenchange', onFSChange);
                        document.removeEventListener('webkitfullscreenchange', onFSChange);
                    };
                    const onFSChange = () => {
                        const fsElement = document.fullscreenElement || document.webkitFullscreenElement;
                        if (!fsElement) cleanup();
                    };
                    document.addEventListener('fullscreenchange', onFSChange);
                    document.addEventListener('webkitfullscreenchange', onFSChange);

                    // 動画が終了またはループ中止で削除（loop=true なので通常はフルスクリーン解除待ち）
                    video.addEventListener('ended', cleanup);
                    video.addEventListener('pause', () => {
                        // ユーザーが停止したら削除
                        if (!video.loop) cleanup();
                    });
                } catch (err) {
                    // 無害なエラーは無視
                    console.error(err);
                }
            }

            // 初回ロード
            loadAndDraw('Atom.jpg');

            // ページロード後に表示
            window.addEventListener('load', () => {
                setTimeout(showAd, 600);
            });

            // 閉じるボタン（クリックでの閉じは再生を許可）
            closeBtn.addEventListener('click', () => hideAd(true));

            // オーバーレイの背景クリックで閉じる（クリックはユーザー操作として扱う）
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) hideAd(true);
            });

            // Escキーで閉じる（キーボード操作は再生を試みない）
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') hideAd(false);
            });

            // リサイズで再描画
            window.addEventListener('resize', () => {
                loadAndDraw('Atom.jpg');
            });
        })();
    </script>
</body>
</html>